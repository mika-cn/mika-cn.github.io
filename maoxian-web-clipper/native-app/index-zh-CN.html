<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="MaoXian 网摘的『本地程序』" />
    <title>本地程序</title>
    <link rel="icon" type="image/png" href="../imgs/logo.png" />
    <link rel="stylesheet" type="text/css" href="../css/markdown.css" />
    <link rel="stylesheet" type="text/css" href="../css/markdown-toc.css" />
  </head>
  <body>
    <div class="main">
      <div class="title"><h1>本地程序</h1></div>

      <input type="checkbox" id="pin-toc" class="pin-toc" hidden>
      <label for="pin-toc" class="pin-toc-switcher" title="pin(unpin) the table of content"></label>
      <div class="toc">
        <h2>目录</h2>
        <ul>
  <li><a href="#intro">简介 </a></li>
  <li><a href="#board">公告 </a></li>
  <li><a href="#features">主要功能 </a></li>
  <li><a href="#install">安装 </a>
    <ul>
      <li><a href="#install-ruby">安装依赖 </a></li>
      <li><a href="#download-package">下载软件包 </a></li>
      <li><a href="#extract-package">解压软件包 </a></li>
      <li><a href="#install-native-app">安装软件 </a></li>
      <li><a href="#configure-download-path">配置下载路径 </a></li>
      <li><a href="#check-and-enable">查看状态并启用 </a></li>
    </ul>
  </li>
  <li><a href="#uninstall">卸载软件 </a></li>
  <li><a href="#upgrade">更新软件 </a></li>
  <li><a href="#apply-config">运用最新的配置 </a></li>
  <li><a href="#faq">常见问题 </a>
    <ul>
      <li>情况A：可以找到日志文件</li>
      <li>情况B：找不到日志文件
        <ul>
          <li>Firefox （火狐）浏览器</li>
          <li>Chromium/Chrome （谷歌）浏览器</li>
          <li><a href="#couldnot-find-ruby">确定和解决浏览器找不到 ruby </a></li>
          <li><a href="#permission-denied">确定是否「本地程序」路径有权限问题 </a></li>
        </ul>
      </li>
      <li><a href="#seeking-help">寻求帮助？ </a></li>
    </ul>
  </li>
</ul>

      </div>

      <div class="content">
<h2 id="intro">简介</h2>

<p>这是一个很小的本地程序，我们开发这个程序增强 Maoxian 的能力。</p>

<blockquote>
  <p><strong>注意</strong>： 如果你只是为了修改 MaoXian 的默认下载目录，则完全没有必要安装『本地程序』，请查看<a href="../faq-zh-CN.html#change-default-download-path">这里</a>查看如何修改默认下载位置。</p>
</blockquote>

<h2 id="board">公告</h2>

<p>ruby 的最新版本（2.7.0）对之前的接口有一些不兼容，这会导致裁剪网页的时候，图片无法下载成功。如果你安装的 ruby 是 <code>2.7.0</code> 以上，则需要安装 <code>0.2.3</code> 以上的「本地程序」才能正常使用。</p>

<h2 id="features">主要功能</h2>

<ul>
  <li>默认
    <ul>
      <li>下载文件 （用于绕过浏览器的下载功能，从而避免与下载管理软件发生冲突）</li>
      <li>删除裁剪信息 （让我们可以删除裁剪历史的同时，删除其对应的文件）</li>
      <li>刷新裁剪历史 （当你有两个裁剪源（比如：一台电脑上的两个浏览器或两台电脑上的浏览器）并且想让浏览器上的裁剪历史保持最新的时候，这一项非常有用。）</li>
    </ul>
  </li>
  <li>Vnote
    <ul>
      <li>以 Vnote 的存储格式，存储裁剪下来的 Markdown 文件。当你对接上 Vnote 后，就可以在 Vnote 上管理你裁剪下来的文件。详情请看<a href="vnote_v1-zh-CN.html">这里</a></li>
    </ul>
  </li>
</ul>

<h2 id="install">安装</h2>

<h3 id="install-ruby">安装依赖</h3>

<p>该软件依赖于 Ruby， 所以我们要先安装 Ruby，请安装 <code>2.4.1</code> 以上版本。</p>

<p><strong>Linux / Mac 用户</strong></p>

<p>很可能系统就自带了 ruby，请用命令 <code>ruby -v</code> 查看。罗嗦一句，如果你是命令行新手，不知道如何运行命令。没关系，每个人都是从新手过来的，不要看到命令行就害怕。请利用搜索引擎学习如何运行命令（比如：搜索 Mac 系统如何运行命令），再走下面的流程。</p>

<p>如果输出的是 ruby 的版本信息，则说明你的系统已经安装了 ruby, 否则请到 <a href="https://www.ruby-lang.org/en/downloads/">ruby 官网</a> 进行安装</p>

<p><strong>Windows 用户</strong></p>

<p>请到 <a href="https://rubyinstaller.org/downloads/">这里</a> 下载安装包，提醒一下，这里直接下载 <code>WITHOUT DEVKIT</code> 下面的版本即可。安装的时候确保勾选上</p>

<ul>
  <li>把 ruby 添加到环境变量（该项必须勾选，否则「本地程序」无法正常启动）。</li>
  <li>使用 UTF-8 作为外部编码 （强烈建议你勾选该项，这样你在跨系统同步文件时候，才不会发生乱码问题）。</li>
</ul>

<p>最好在安装成功后，验证一下。通过 <kbd>Win</kbd>+<kbd>R</kbd> 调出运行窗口 &gt; 输入 <code>cmd</code> 回车 &gt; 输入 <code>ruby -v</code> 回车 。如果输出的是 ruby 的版本信息，则说明 ruby 安装成功，并且已经添加到环境变量。</p>

<h3 id="download-package">下载软件包</h3>

<p>请根据你的系统信息和浏览器类型， 下载对应的软件包</p>

<p>当前版本 <code>0.2.12</code></p>

<ul>
  <li>Linux
    <ul>
      <li><a href="files/0.2.12/maoxian-web-clipper-native-linux-chrome-0.2.12.zip">native-app-chrome.zip</a></li>
      <li><a href="files/0.2.12/maoxian-web-clipper-native-linux-chromium-0.2.12.zip">native-app-chromium.zip</a></li>
      <li><a href="files/0.2.12/maoxian-web-clipper-native-linux-firefox-0.2.12.zip">native-app-firefox.zip</a></li>
    </ul>
  </li>
  <li>Mac
    <ul>
      <li><a href="files/0.2.12/maoxian-web-clipper-native-macos-chrome-0.2.12.zip">native-app-chrome.zip</a></li>
      <li><a href="files/0.2.12/maoxian-web-clipper-native-macos-chromium-0.2.12.zip">native-app-chromium.zip</a></li>
      <li><a href="files/0.2.12/maoxian-web-clipper-native-macos-firefox-0.2.12.zip">native-app-firefox.zip</a></li>
    </ul>
  </li>
  <li>Windows
    <ul>
      <li><a href="files/0.2.12/maoxian-web-clipper-native-windows-chrome-0.2.12.zip">native-app-chrome.zip</a></li>
      <li><a href="files/0.2.12/maoxian-web-clipper-native-windows-chromium-0.2.12.zip">native-app-chromium.zip</a></li>
      <li><a href="files/0.2.12/maoxian-web-clipper-native-windows-firefox-0.2.12.zip">native-app-firefox.zip</a></li>
    </ul>
  </li>
</ul>

<h3 id="extract-package">解压软件包</h3>

<p>这一步骤里的解压位置，即『本地程序』的安装位置，需保证浏览器有权限访问该位置。</p>

<ul>
  <li>Linux 用户，<strong>请解压到用户目录下，以避免权限相关的问题</strong>。以下命令解压到 <code>~/.local/apps</code> 目录下，你可自行调整其位置。</li>
</ul>

<pre><code class="language-shell">mkdir -p ~/.local/apps
unzip ~/Downloads/maoxian-web-clipper-native-linux-chromium.zip -d ~/.local/apps/maoxian-web-clipper-native

</code></pre>

<ul>
  <li>Mac 用户，<strong>请解压到 <code>/Applications</code> 目录，以避免权限相关问题</strong>。</li>
</ul>

<pre><code class="language-shell">unzip ~/Downloads/maoxian-web-clipper-native-linux-chromium.zip -d /Applications/maoxian-web-clipper-native
</code></pre>

<ul>
  <li>Windows 用户</li>
</ul>

<pre><code class="language-shell">额，使用任何你喜欢的解压软件，把它解压到用户目录下的某个文件夹（由于是直接打包的文件，没有打包根文件夹）, :D
</code></pre>

<h3 id="install-native-app">安装软件</h3>

<p><strong>注</strong>: 如果你的浏览器是基于 Chromium 或 Firefox 开发的浏览器，请使用<a href="install-on-other-browsers-zh-CN.html">这里</a>的安装教程。</p>

<p>进入你的『本地程序』文件夹里，然后：</p>

<ul>
  <li>在 Linux 或 Mac 上，直接运行 <code>./install.sh</code> 进行安装</li>
  <li>在 Windows 上，直接双击 <code>install.bat</code> （注意：你点击后，会发现有个命令窗口跳出来，程序会进行安装，安装完成后会显示：”press any key to continue” 则直接按下 Enter 键就好了。 ）</li>
</ul>

<p>这一步骤做的事情是：把『本地程序』的当前位置告知给浏览器。当 MaoXian 扩展需要和『本地程序』交互时，浏览器就可以找到『本地程序』的位置。所以<strong>安装过后，就不要移动，删除或重命名『本地程序』文件夹了。</strong> 如果你非要移动，或重命名『本地程序』文件夹，你需要再运行一遍安装脚本，告诉浏览器新的『本地程序』位置。</p>

<h3 id="configure-download-path">配置下载路径</h3>

<p>在开始使用之前，我们需要先配置，下载路径，也就是裁剪下来的文件存储的目录（等同于浏览器的下载目录）</p>

<p>编辑 <code>config.yaml</code> 的 <code>data_dir</code> 的值， （随便用一个文本编辑器就可编辑）</p>

<p><code>config.yaml</code> 这个文件<strong>必须是 UTF-8 的编码格式</strong>。 如果你是在 Windows 上的话，别用记事本打开，找一个能正确处理换行符的编辑器（比如 <code>notepad++</code>）。并且确保你保存的编码格式为 UTF-8 （有的编辑器在 Windows 上的默认编码格式不是 UTF-8，这点需要注意）。</p>

<p><strong>注意： 配置的下载路径必须真实存在，『本地程序』启动时会检查该路径，不存在，则启动失败</strong></p>

<p>Linux / Mac 例子</p>

<pre><code class="language-yaml"># config.yaml
environment: 'production'
data_dir: '/home/jack/clippings'
# avariable handler: 'default', 'vnote_v1'
msg_handler: 'default'
</code></pre>

<p>windows 例子</p>

<pre><code class="language-yaml"># config.yaml
environment: 'production'
data_dir: 'e:\jack\clippings'
msg_handler: 'default'
</code></pre>

<p>注意上方的 <code>msg_handler</code> 目前支持兩個值 <code>default</code> 和 <code>vnote_v1</code> 。如果你要對接 Vnote ，那麼請點擊<a href="vnote_v1-zh-CN.html">這裏</a>，查看如何對接。</p>

<h3 id="check-and-enable">查看状态并启用</h3>

<p>请重启你的浏览器后，到 <strong>扩展设置页面 &gt; 本地程序</strong> 小节查看当前状态。</p>

<ol>
  <li>请先查看『权限』那一小节，你需要授权一个权限，根据页面提示，如果还没有授权，则点击『授予权限』按钮进行授权。</li>
  <li>授权成功后，查看『当前状态』那一小节，如果能看到 「本地程序」的版本号，则 MaoXian 扩展已经和 「本地程序」对接上了。如果显示的是错误信息，请查看下方 <a href="#faq">常见错误</a> 小节，排查错误。</li>
  <li>确保对接上后，请勾选下方的 <strong>启用该处理程序</strong> 。</li>
</ol>

<p>在两者对接上，并且「本地程序」已启用后。就可以使用「本地程序」了，比如到 <strong>扩展设置页面 &gt; 存储设置</strong> 选用「本地程序」来下载裁剪结果。</p>

<p><strong>注：</strong> 如果你需要在浏览器上预览你裁剪下来的文件， 我们强烈建议你 <strong><a href="../faq-zh-CN.html#allow-access-file-urls">允许 MaoXian 访问本地网址</a></strong>，以便可以方便地查看裁剪下来的文件。</p>

<h2 id="uninstall">卸载软件</h2>

<p>Linux 或 Mac  直接运行 <code>./uninstall.sh</code> 脚本，再删除掉整个程序目录。</p>

<p>在 Windows 上，直接双击 <code>uninstall.bat</code>，再删除掉整个程序目录。</p>

<h2 id="upgrade">更新软件</h2>

<ol>
  <li>先备份 Native App 目录下的 <code>config.yaml</code> (复制到别的地方)</li>
  <li><a href="#uninstall">卸载 Native App</a></li>
  <li>在本页面<a href="#download-package">下载最新版本</a>，<a href="#extract-package">再解压软件包</a></li>
  <li>用你备份的 <code>config.yaml</code> 覆盖解压出来的文件夹的 config.yaml.</li>
  <li><a href="#install-native-app">安装新的程序</a></li>
</ol>

<h2 id="apply-config">运用最新的配置</h2>

<p>有些用户更改了 config.yaml 里的配置，却发现扩展并没有马上应用最新的配置信息。这是属于正常现象，因为『本地程序』只在浏览器启动它时，才会去读取配置。你可以到 <code>设置页面 &gt; 本地程序</code> 那里，点击『重新加载』按钮来加载最新的配置。你也可以通过重启浏览器的方法加载最新配置。</p>

<h2 id="faq">常见问题</h2>

<p>一般情况下，当你的 ruby 版本是正确的（大于2.4.1），并且已经将其添加到环境变量里。并且配置文件 config.yaml 里面的存储路径是真实存在的路径，「本地程序」会和 MaoXian 对接成功。如果你仔细走完了上面的安装流程，还是无法对接上的话。 请检查日志文件：tmp/app.log (在安装目录下) 是否存在，若存在则可以使用任何文本编辑器打开它进行进一步排查。</p>

<p>在进行下面检查之前，你得确保你至少运行过安装脚本，并且到 <strong>扩展设置页面 &gt; 本地程序</strong> 页面查看过状态信息，并且其显示的是某个错误信息。</p>

<h3 id="a">情况A：可以找到日志文件</h3>

<p>找到日志文件意味着：「本地程序」已经由浏览器启动，并产生日志。</p>

<p>如果在日志文件中，发现错误：”<em>(./config.yaml): invalid trailing UTF-8 octet at line xxx column xxx</em>“，则表示你的配置文件的编码格式不是 UTF-8 ，则重新把配置文件 config.yaml 另存为 UTF-8 编码格式，即可修复。修复完后，在 <strong>扩展设置 &gt; 本地程序</strong> 页面上，点击『重新加载』按钮。</p>

<p>如果在日志文件中，发现错误： “<em>Config Invalid, data_dir not exist: xxxxx</em>” ，则表示你配置文件 config.yaml 里面的 data_dir 配置的路径，在你的系统中是不存在的。则你需要新建对应的文件夹或者配置一个存在的路径。修复完后，在 <strong>扩展设置 &gt; 本地程序</strong> 页面上，点击『重新加载』按钮。</p>

<p>若遇到其他错误信息，请<a href="#seeking-help">寻求帮助</a></p>

<h3 id="b">情况B：找不到日志文件</h3>

<p>请根据 <strong>扩展设置 &gt; 本地程序</strong> 页面上的错误信息，对应下文进行排查。</p>

<h4 id="firefox-">Firefox （火狐）浏览器</h4>

<p>错误信息：</p>

<blockquote>
  <p>ErrorMessage: NativeApp: DisconnectErr:No such native application maoxian_web_clipper_native</p>
</blockquote>

<p>可能原因：</p>

<ul>
  <li>你还没有安装「本地程序」（即没有运行安装脚本），【请先安装】</li>
  <li>你的浏览器是基于 Firefox 开发的浏览器，并且它没有对一些目录做兼容，你需要按照这个教程来：<a href="./install-on-other-browsers-zh-CN.html">基于Chromium 或 Firefox 开发的浏览器如何安装『本地程序』</a>。</li>
</ul>

<hr />

<p>错误信息：</p>

<blockquote>
  <p>ErrorMessage: NativeApp: DisconnectErr:An unexpected error occurred</p>
</blockquote>

<p>可能原因：</p>

<ul>
  <li>你安装过后，「本地程序」文件夹的位置或名字发生了变化。 【请再运行一次安装脚本】</li>
</ul>

<hr />

<p>错误信息：</p>

<blockquote>
  <p>ErrorMessage: Unknown Error</p>
</blockquote>

<p>可能原因：</p>

<ul>
  <li>浏览器找不到 ruby 【请确保 ruby 已安装，并已经添加到环境变量，详见：<a href="#couldnot-find-ruby">确定和解决浏览器找不到 ruby</a>】</li>
  <li>浏览器无权访问「本地程序」【请检查「本地程序」的路径权限，详见：<a href="#permission-denied">确定是否「本地程序」路径有权限问题</a>】</li>
</ul>

<hr />

<p>错误信息：</p>

<blockquote>
  <p>ErrorMessage: LogErr, Permission denied @ rb_sysopen - /xxx/xxx/xxx/tmp/app.log</p>
</blockquote>

<p>原因：</p>

<ul>
  <li>ruby 无权限创建 logger 文件【请检查「本地程序」的路径权限】</li>
</ul>

<h4 id="chromiumchrome-">Chromium/Chrome （谷歌）浏览器</h4>

<p>错误信息：</p>

<blockquote>
  <p>ErrorMessage: this.API.connectNative is not a function</p>
</blockquote>

<p>原因：</p>

<ul>
  <li>有时候 Chromium/Chrome 在你授权给 「本地程序」通信的权限后，该权限无法立即生效。【请重启浏览器，以使其生效】</li>
</ul>

<hr />

<p>错误信息：</p>

<blockquote>
  <p>ErrorMessage: NativeApp: DisconnectErr:Specified native messaging host not found.</p>
</blockquote>

<p>可能原因：</p>

<ul>
  <li>你还没有安装「本地程序」（即没有运行安装脚本），【请先安装】</li>
  <li>你安装过后，「本地程序」文件夹的位置或名字发生了变化。 【请再运行一次安装脚本】</li>
  <li>你的浏览器是基于 Chromium 开发的浏览器，并且其没有对一些目录做兼容，你需要按照这个教程来：<a href="./install-on-other-browsers-zh-CN.html">基于Chromium 或 Firefox 开发的浏览器如何安装『本地程序』</a>。</li>
</ul>

<hr />

<p>错误信息：</p>

<blockquote>
  <p>ErrorMessage: NativeApp: DisconnectErr:Native host has exited.</p>
</blockquote>

<p>可能原因：</p>

<ul>
  <li>浏览器找不到 ruby 【请确保 ruby 已安装，并已经添加到环境变量，详见：<a href="#couldnot-find-ruby">确定和解决浏览器找不到 ruby</a>】</li>
  <li>浏览器无权访问「本地程序」【请检查「本地程序」的路径权限，详见：<a href="#permission-denied">确定是否「本地程序」路径有权限问题</a>】</li>
</ul>

<hr />

<p>错误信息：</p>

<blockquote>
  <p>ErrorMessage: LogErr, Permission denied @ rb_sysopen - /xxx/xxx/xxx/tmp/app.log</p>
</blockquote>

<p>原因：</p>

<ul>
  <li>ruby 无权限创建 logger 文件【请检查「本地程序」的路径权限】</li>
</ul>

<h4 id="couldnot-find-ruby">确定和解决浏览器找不到 ruby</h4>

<p>1) ruby 安装不正确。</p>

<p>请确保当你运行 <code>ruby -v</code> 的时候，可以得到正确的 ruby 版本。如若不是，则重新安装即可。请确保 ruby 已经添加到环境变量里。</p>

<p>2) 虽然 ruby 安装成功，但是浏览器无法找到它。</p>

<p>这种情况一般发生在 Mac 或 Linux 用户身上，如果你采用的是源码安装的方式，你可能会碰到此问题。</p>

<p><strong>如何确认</strong></p>

<p>可以通过从命令行启动浏览器的方式来确认，比如运行 <code>/usr/bin/chromium-browser</code> 命令，然后再到 <strong>扩展设置页面 &gt; 本地程序</strong> 页面，再查看命令行的输出，可以看到类似 “/usr/bin/env: ‘ruby’: No such file or directory” 这样的错误信息。</p>

<p><strong>如何解决</strong></p>

<p>把 main.rb (安装目录下) 第一行的 “/usr/bin/env ruby” 改成 ruby 的绝对路径，比如 “/home/jack/ruby-2.5.0/bin/ruby”。 或者是创建一个软链接到 /usr/bin 目录下，比如： <code>ln -s /home/jack/ruby-2.5.0/bin/ruby /usr/bin/ruby</code>。</p>

<h4 id="permission-denied">确定是否「本地程序」路径有权限问题</h4>

<p>0）先关闭浏览器。</p>

<p>1）找到浏览器的位置，比如在 Linux 上通过 <code>whereis chromium</code>。</p>

<p>2） 使用命令行的方式启动浏览器，如：运行命令 <code>/usr/bin/chromium</code> ，启动浏览器，再到 MaoXian 设置页面查看「本地程序」的状态，观察到错误后，查看命令行有没有相关错误信息。</p>

<p>如果有权限问题，一般可以观察到： <code>Operation not permitted</code> 或者 <code>Permission denied</code> 语句，如下面的 Chromium 的命令行输出：</p>

<pre><code class="language-shell">shell-init: error retrieving current directory: getcwd: cannot access parent directories: Operation not permitted
ruby: Operation not permitted -- /Users/test/Downloads/maoxian-web-clipper-native/main.rb (LoadError)
</code></pre>

<p>一般为整个路径的某个目录权限不允许，则把本地程序复制到别的地方（参考<a href="#extract-package">解压软件包</a>那一小节），即可修复。</p>

<h3 id="seeking-help">寻求帮助？</h3>

<ul>
  <li>请到 <a href="https://github.com/mika-cn/maoxian-web-clipper/issues">项目 issue 页</a> ，先进行搜索，看有无相关问题。</li>
  <li>如果搜索完还无法解决，请在 <a href="https://github.com/mika-cn/maoxian-web-clipper/issues">项目 issue 页</a> ，给开发者提个issue，或者发邮件到（i [DOT] mika [AT] tutanota [DOT] com 请将 [DOT] 替换为英文句号：”.”，将[AT] 替换为邮件符号：”@”，并删除所有空格），若你无法访问项目 issue 页面（无法搜索相关问题），也可通过发送邮件寻求帮助。</li>
  <li>为了更有效地沟通，请提供以下信息：</li>
  <li>环境信息：系统名字，浏览器名字，ruby 版本，「本地程序」版本。</li>
  <li><em>设置 &gt; 本地程序</em> 页面上的错误信息。</li>
  <li>能否查看到日志文件。若有，记得把日志内容带上。</li>
</ul>

<hr />
<p><a href="../index-zh-CN.html">首页</a></p>
</div>
    </div>
  </body>
</html>

